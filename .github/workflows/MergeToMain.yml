name: Merge into 'main'

on:
  push:
    branches: [main]
    paths-ignore:
      - '.editorconfig'
      - 'ReadMe.md'
      - 'ChangeLog.md'
      - '.github/workflows/PullRequest.yml'
      - '.github/workflows/Release.yml'

permissions:
  packages: write

env:
  DOTNET_NOLOGO: true

jobs:
  build_and_test:
    name: Build and Test
    uses: ./.github/workflows/reusable-build-test.yml
    with:
      version: ${{ github.run_number }}.0.0-beta
    secrets:
      codecov_token: ${{ secrets.CODECOV_TOKEN }}

  build_and_push_docker:
    name: Build and Push Docker Image
    needs: build_and_test
    uses: ./.github/workflows/reusable-docker.yml
    with:
      dockerfile_path: ./code/WorldDomination.SimpleObservability.Dashboard/Dockerfile
      registry: ghcr.io
      registry_username: ${{ github.repository_owner }}
      image_name: ${{ github.repository_owner }}/dashboard
      push: true
      tags_config: |
        type=raw,value=${{ github.run_number }}.0.0-beta
        type=raw,value=beta
    secrets:
      registry_password: ${{ secrets.GITHUB_TOKEN }}
